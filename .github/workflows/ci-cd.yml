# CI/CD Pipeline –¥–ª—è Drill Pipe Project
# –≠—Ç–æ—Ç —Ñ–∞–π–ª –æ–ø–∏—Å—ã–≤–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è,
# –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º push –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π

name: CI/CD Pipeline

# –ö–û–ì–î–ê –ó–ê–ü–£–°–ö–ê–¢–¨ (Triggers)

# Workflow –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —Å–ª—É—á–∞—è—Ö:
on:
  # 1. –ü—Ä–∏ push –≤ –≤–µ—Ç–∫–∏ main –∏–ª–∏ master
  push:
    branches:
      - main
      - master
      - develop
  
  # 2. –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Pull Request
  pull_request:
    branches:
      - main
      - master
      - develop

# –ó–ê–î–ê–ß–ò (Jobs)
# Job = –Ω–∞–±–æ—Ä —à–∞–≥–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
# Jobs –º–æ–≥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∏–ª–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ

jobs:
  
  # –ó–ê–î–ê–ß–ê 1: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ Backend
  test-backend:
    name: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Backend
    # –ù–∞ –∫–∞–∫–æ–π –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –∑–∞–ø—É—Å–∫–∞—Ç—å (–º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å: ubuntu, windows, macos)
    runs-on: ubuntu-latest
    
    # –®–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    steps:
      # –®–ê–ì 1: –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: üì• –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ (Checkout)
        uses: actions/checkout@v4
      
      # –®–ê–ì 2: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Node.js
      - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      # –®–ê–ì 3: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Backend
      - name: üìö –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Backend
        working-directory: ./backend
        run: npm ci
      
      # –®–ê–ì 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–Ω—Ç–µ—Ä–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
      # - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–Ω—Ç–µ—Ä–∞ Backend
      #   working-directory: ./backend
      #   run: npm run lint
      #   continue-on-error: true  # –ù–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å pipeline, –µ—Å–ª–∏ –ª–∏–Ω—Ç–µ—Ä –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
      
      # –®–ê–ì 5: –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –∫–æ–¥ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è
      - name: ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ Backend
        working-directory: ./backend
        run: |
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞..."
          node --version
          npm --version

  # –ó–ê–î–ê–ß–ê 2: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ Frontend
  test-frontend:
    name: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ (Checkout)
        uses: actions/checkout@v4
      
      - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: üìö –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Frontend
        working-directory: ./frontend
        run: npm ci
      
      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–Ω—Ç–µ—Ä–∞ Frontend
        working-directory: ./frontend
        run: npm run lint
        continue-on-error: true
      
      - name: üèóÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±–æ—Ä–∫–∏ Frontend
        working-directory: ./frontend
        run: npm run build
        env:
          # –í CI –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É –¥–ª—è API URL
          VITE_API_URL: http://localhost:5000/

  # –ó–ê–î–ê–ß–ê 3: –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤
  build-docker:
    name: –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤
    runs-on: ubuntu-latest
    # –≠—Ç–∞ –∑–∞–¥–∞—á–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤
    needs: [test-backend, test-frontend]
    
    steps:
      - name: üì• –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ (Checkout)
        uses: actions/checkout@v4
      
      # –®–ê–ì 1: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Docker Buildx
      # Buildx –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–±–∏—Ä–∞—Ç—å –æ–±—Ä–∞–∑—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º
      - name: üê≥ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # –®–ê–ì 2: –°–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑ Backend
      - name: üèóÔ∏è –°–æ–±—Ä–∞—Ç—å Docker –æ–±—Ä–∞–∑ Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: false  # –ü–æ–∫–∞ –Ω–µ –ø—É—à–∏–º –≤ registry (–º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –ø–æ–∑–∂–µ)
          tags: dril-pipe-backend:latest
          cache-from: type=gha  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–µ—à GitHub Actions
          cache-to: type=gha,mode=max
      
      # –®–ê–ì 3: –°–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑ Frontend
      - name: üèóÔ∏è –°–æ–±—Ä–∞—Ç—å Docker –æ–±—Ä–∞–∑ Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: false
          tags: dril-pipe-frontend:latest
          build-args: |
            VITE_API_URL=http://localhost:5000/
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      # –®–ê–ì 4: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ–±—Ä–∞–∑—ã —Å–æ–±—Ä–∞–ª–∏—Å—å
      - name: ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤
        run: |
          docker images | grep dril-pipe
          echo "‚úÖ –í—Å–µ –æ–±—Ä–∞–∑—ã —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω—ã!"

  # –ó–ê–î–ê–ß–ê 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ Docker Compose
  # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ docker-compose —Ä–∞–±–æ—Ç–∞–µ—Ç
  # test-docker-compose:
  #   name: –¢–µ—Å—Ç Docker Compose
  #   runs-on: ubuntu-latest
  #   needs: build-docker
  #   
  #   steps:
  #     - name: üì• –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥
  #       uses: actions/checkout@v4
  #     
  #     - name: üê≥ –ó–∞–ø—É—Å—Ç–∏—Ç—å Docker Compose
  #       run: |
  #         docker-compose up -d
  #         sleep 30  # –ñ–¥—ë–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
  #         docker-compose ps
  #         docker-compose down

