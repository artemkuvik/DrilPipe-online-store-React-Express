# CI/CD Pipeline –¥–ª—è Drill Pipe Project.
# –≠—Ç–æ—Ç —Ñ–∞–π–ª –æ–ø–∏—Å—ã–≤–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è,
# –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º push –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π

name: CI/CD Pipeline

# –ö–û–ì–î–ê –ó–ê–ü–£–°–ö–ê–¢–¨ (Triggers)

# Workflow –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —Å–ª—É—á–∞—è—Ö:
on:
  # 1. –ü—Ä–∏ push –≤ –≤–µ—Ç–∫–∏ main –∏–ª–∏ master
  push:
    branches:
      - main
      - master
      - develop
  
  # 2. –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Pull Request
  pull_request:
    branches:
      - main
      - master
      - develop

# –ó–ê–î–ê–ß–ò (Jobs)
# Job = –Ω–∞–±–æ—Ä —à–∞–≥–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
# Jobs –º–æ–≥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∏–ª–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ

jobs:
  
  # –ó–ê–î–ê–ß–ê 1: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ Backend
  test-backend:
    name: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Backend
    # –ù–∞ –∫–∞–∫–æ–π –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –∑–∞–ø—É—Å–∫–∞—Ç—å (–º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å: ubuntu, windows, macos)
    runs-on: ubuntu-latest
    
    # –®–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    steps:
      # –®–ê–ì 1: –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: üì• –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ (Checkout)
        uses: actions/checkout@v4
      
      # –®–ê–ì 2: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Node.js
      - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      # –®–ê–ì 3: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Backend
      - name: üìö –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Backend
        working-directory: ./backend
        run: npm ci
      
      # –®–ê–ì 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–Ω—Ç–µ—Ä–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
      # - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–Ω—Ç–µ—Ä–∞ Backend
      #   working-directory: ./backend
      #   run: npm run lint
      #   continue-on-error: true  # –ù–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å pipeline, –µ—Å–ª–∏ –ª–∏–Ω—Ç–µ—Ä –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
      
      # –®–ê–ì 5: –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –∫–æ–¥ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è
      - name: ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ Backend
        working-directory: ./backend
        run: |
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞..."
          node --version
          npm --version

  # –ó–ê–î–ê–ß–ê 2: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ Frontend
  test-frontend:
    name: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ (Checkout)
        uses: actions/checkout@v4
      
      - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: üìö –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Frontend
        working-directory: ./frontend
        run: npm ci
      
      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–Ω—Ç–µ—Ä–∞ Frontend
        working-directory: ./frontend
        run: npm run lint
        continue-on-error: true
      
      - name: üèóÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±–æ—Ä–∫–∏ Frontend
        working-directory: ./frontend
        run: npm run build
        env:
          # –í CI –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É –¥–ª—è API URL
          VITE_API_URL: http://localhost:5000/

  # –ó–ê–î–ê–ß–ê 3: –°–±–æ—Ä–∫–∞ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è Docker –æ–±—Ä–∞–∑–æ–≤
  build-and-push-docker:
    name: –°–±–æ—Ä–∫–∞ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è Docker –æ–±—Ä–∞–∑–æ–≤
    runs-on: ubuntu-latest
    # –≠—Ç–∞ –∑–∞–¥–∞—á–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤
    needs: [test-backend, test-frontend]
    # –ü—É–±–ª–∏–∫—É–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ push –≤ main (–Ω–µ –ø—Ä–∏ PR)
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
      - name: üì• –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ (Checkout)
        uses: actions/checkout@v4
      
      # –®–ê–ì 1: –í—Ö–æ–¥ –≤ GitHub Container Registry
      - name: üîê –í—Ö–æ–¥ –≤ GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      # –®–ê–ì 2: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Docker Buildx
      - name: üê≥ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # –®–ê–ì 3: –°–æ–±—Ä–∞—Ç—å –∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –æ–±—Ä–∞–∑ Backend
      - name: üèóÔ∏è –°–æ–±—Ä–∞—Ç—å –∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å Docker –æ–±—Ä–∞–∑ Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/dril-pipe-backend:latest
            ghcr.io/${{ github.repository_owner }}/dril-pipe-backend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      # –®–ê–ì 4: –°–æ–±—Ä–∞—Ç—å –∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –æ–±—Ä–∞–∑ Frontend
      - name: üèóÔ∏è –°–æ–±—Ä–∞—Ç—å –∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å Docker –æ–±—Ä–∞–∑ Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/dril-pipe-frontend:latest
            ghcr.io/${{ github.repository_owner }}/dril-pipe-frontend:${{ github.sha }}
          build-args: |
            VITE_API_URL=${{ secrets.VITE_API_URL || 'http://localhost:5000/' }}
          # –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤:
          # env:
          #   VITE_API_URL: ${{ secrets.VITE_API_URL || 'http://localhost:5000/' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      # –®–ê–ì 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
      - name: ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –æ–±—Ä–∞–∑–æ–≤
        run: |
          echo "‚úÖ –í—Å–µ –æ–±—Ä–∞–∑—ã —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω—ã –∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω—ã!"
          echo "Backend: ghcr.io/${{ github.repository_owner }}/dril-pipe-backend:latest"
          echo "Frontend: ghcr.io/${{ github.repository_owner }}/dril-pipe-frontend:latest"

  # –ó–ê–î–ê–ß–ê 4: –î–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ GitHub Actions (CD)
  deploy:
    name: –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    runs-on: ubuntu-latest
    needs: [build-and-push-docker]
    # –î–µ–ø–ª–æ–∏–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ push –≤ main/master
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
      - name: üì• –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ (Checkout)
        uses: actions/checkout@v4
      
      # –®–ê–ì 1: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É —á–µ—Ä–µ–∑ SSH
      - name: üîê –ù–∞—Å—Ç—Ä–æ–∏—Ç—å SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      # –®–ê–ì 2: –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      - name: üöÄ –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH || '/var/www/dril-pipe' }}
          REPO_OWNER: ${{ github.repository_owner }}
        run: |
          ssh -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST} "
            cd ${DEPLOY_PATH} &&
            git pull origin main &&
            docker-compose down &&
            docker pull ghcr.io/${REPO_OWNER}/dril-pipe-backend:latest &&
            docker pull ghcr.io/${REPO_OWNER}/dril-pipe-frontend:latest &&
            docker-compose up -d &&
            docker image prune -f &&
            echo '‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ!'
          "

  # –ó–ê–î–ê–ß–ê 5: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  notify:
    name: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always() && github.event_name == 'push'
    
    steps:
      - name: ‚úÖ –£—Å–ø–µ—à–Ω—ã–π –¥–µ–ø–ª–æ–π
        if: success()
        run: |
          echo "‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω!"
          echo "–û–±—Ä–∞–∑—ã –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω—ã –≤ GitHub Container Registry"
          echo "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
      
      - name: ‚ùå –û—à–∏–±–∫–∞ –¥–µ–ø–ª–æ—è
        if: failure()
        run: |
          echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–µ–ø–ª–æ–µ!"
          echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π"

  

