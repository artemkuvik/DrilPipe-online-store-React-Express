# ============================================
# ЭТАП 1: СБОРКА (Build Stage)
# ============================================
# Здесь мы компилируем React приложение в статические файлы

FROM node:20-alpine AS builder

# Рабочая директория
WORKDIR /app

# Копируем файлы зависимостей
COPY package*.json ./

# Устанавливаем зависимости
RUN npm install

# Копируем весь код
COPY . .

# ВАЖНО: VITE_API_URL будет передан при сборке через --build-arg
# Это нужно, чтобы при сборке React знал, куда обращаться к API
ARG VITE_API_URL
ENV VITE_API_URL=$VITE_API_URL

# Собираем проект (создастся папка dist с готовыми файлами)
RUN npm run build

# ============================================
# ЭТАП 2: ПРОДАКШЕН (Production Stage)
# ============================================
# Здесь мы берём собранные файлы и отдаём их через nginx

FROM nginx:alpine

# Копируем собранные файлы из этапа сборки
# dist - это папка, которую создал Vite после сборки
COPY --from=builder /app/dist /usr/share/nginx/html

# Копируем конфигурацию nginx (создадим её отдельно)
# Это нужно, чтобы правильно обрабатывать React Router
COPY nginx.conf /etc/nginx/conf.d/default.conf

# Открываем порт 80 (стандартный порт для веб-серверов)
EXPOSE 80

# nginx запускается автоматически при старте контейнера
CMD ["nginx", "-g", "daemon off;"]

